# 改修仕様書 2: エラーハンドリングの統一化

## 目的
アプリケーション全体で一貫したエラーハンドリングを実現し、エラー処理の重複を排除する。

## 背景
- エラーハンドリングが各コンポーネントで個別に実装されており、一貫性がない
- `presentError`のような関数が重複している可能性がある
- エラーメッセージの形式が統一されていない
- エラーの種類に応じた適切な処理ができていない

## 実施内容

### 1. エラーハンドリングユーティリティの作成
- **ファイル**: `src/utils/errorHandler.ts` を新規作成
- **内容**:
  - エラーの正規化関数
  - エラーメッセージの生成関数
  - エラーログ出力関数
  - エラータイプの判定関数

### 2. エラー型定義の拡張
- **ファイル**: `src/types/index.ts` を更新
- **内容**:
  - エラーの種類を定義（`ErrorType` enum）
  - エラーコンテキストの型定義

### 3. 既存ファイルの更新
- **`src/ImageGenerator.jsx`**:
  - `presentError`関数を削除
  - エラーハンドリングユーティリティを使用

- **`src/lib/authService.js`**:
  - エラーハンドリングを統一化

- **`src/components/ImageHistoryTable.jsx`**:
  - エラーハンドリングを統一化

## 実装詳細

### `src/utils/errorHandler.ts`
```typescript
import { ErrorWithCode, AppError } from '../types';

export enum ErrorType {
  NETWORK = 'NETWORK',
  AUTH = 'AUTH',
  VALIDATION = 'VALIDATION',
  DATABASE = 'DATABASE',
  API = 'API',
  UNKNOWN = 'UNKNOWN',
}

export interface ErrorContext {
  component?: string;
  action?: string;
  userId?: string;
  [key: string]: any;
}

/**
 * エラーを正規化する
 */
export const normalizeError = (error: unknown): AppError => {
  if (error instanceof Error) {
    const errorWithCode = error as ErrorWithCode;
    return {
      message: error.message || 'エラーが発生しました',
      code: errorWithCode.code,
      details: errorWithCode.details,
      hint: errorWithCode.hint,
    };
  }
  
  if (typeof error === 'string') {
    return { message: error };
  }
  
  return { message: '不明なエラーが発生しました' };
};

/**
 * エラータイプを判定する
 */
export const getErrorType = (error: unknown): ErrorType => {
  const normalized = normalizeError(error);
  
  if (normalized.code === 'TOKEN_EXPIRED' || normalized.code === 'PGRST116') {
    return ErrorType.AUTH;
  }
  
  if (normalized.message?.includes('network') || normalized.message?.includes('fetch')) {
    return ErrorType.NETWORK;
  }
  
  if (normalized.code?.startsWith('PGRST') || normalized.message?.includes('relation')) {
    return ErrorType.DATABASE;
  }
  
  if (normalized.message?.includes('API') || normalized.message?.includes('api')) {
    return ErrorType.API;
  }
  
  return ErrorType.UNKNOWN;
};

/**
 * ユーザーフレンドリーなエラーメッセージを生成
 */
export const getUserFriendlyMessage = (error: unknown, context?: ErrorContext): string => {
  const normalized = normalizeError(error);
  const errorType = getErrorType(error);
  
  switch (errorType) {
    case ErrorType.AUTH:
      if (normalized.code === 'TOKEN_EXPIRED') {
        return 'セッションの有効期限が切れました。再度ログインしてください。';
      }
      return '認証エラーが発生しました。再度ログインしてください。';
    
    case ErrorType.NETWORK:
      return 'ネットワークエラーが発生しました。インターネット接続を確認してください。';
    
    case ErrorType.DATABASE:
      if (normalized.message?.includes('does not exist') || normalized.message?.includes('relation')) {
        return 'データベーステーブルが存在しません。マイグレーションを実行してください。';
      }
      return 'データベースエラーが発生しました。';
    
    case ErrorType.API:
      return normalized.message || 'APIエラーが発生しました。';
    
    case ErrorType.VALIDATION:
      return normalized.message || '入力値が正しくありません。';
    
    default:
      return normalized.message || 'エラーが発生しました。';
  }
};

/**
 * エラーをログ出力する
 */
export const logError = (error: unknown, context?: ErrorContext): void => {
  const normalized = normalizeError(error);
  const errorType = getErrorType(error);
  
  console.error(`[${errorType}] ${normalized.message}`, {
    error: normalized,
    context,
    timestamp: new Date().toISOString(),
  });
};

/**
 * エラーを処理してユーザーに表示するためのメッセージを返す
 */
export const handleError = (error: unknown, context?: ErrorContext): string => {
  logError(error, context);
  return getUserFriendlyMessage(error, context);
};
```

### `src/types/index.ts` への追加
```typescript
// エラー関連の型定義（既存の型定義に追加）
export enum ErrorType {
  NETWORK = 'NETWORK',
  AUTH = 'AUTH',
  VALIDATION = 'VALIDATION',
  DATABASE = 'DATABASE',
  API = 'API',
  UNKNOWN = 'UNKNOWN',
}

export interface ErrorContext {
  component?: string;
  action?: string;
  userId?: string;
  [key: string]: any;
}
```

## テスト要件
- 各種エラータイプが正しく判定されることを確認
- ユーザーフレンドリーなメッセージが生成されることを確認
- エラーログが正しく出力されることを確認
- 既存の機能が壊れていないことを確認

## 影響範囲
- `src/ImageGenerator.jsx`
- `src/lib/authService.js`
- `src/components/ImageHistoryTable.jsx`
- 新規ファイル: `src/utils/errorHandler.ts`
- 更新ファイル: `src/types/index.ts`

## 完了条件
- [ ] `src/utils/errorHandler.ts`が作成され、エラーハンドリング関数が実装されている
- [ ] `src/types/index.ts`にエラー関連の型定義が追加されている
- [ ] 既存のコンポーネントが新しいエラーハンドリングを使用するように更新されている
- [ ] 既存の機能が正常に動作することを確認
- [ ] エラーメッセージが統一された形式で表示されることを確認

## 注意事項
- 既存のエラーメッセージの表示が大きく変わらないように注意する
- ユーザーに表示されるメッセージは、技術的な詳細を隠しつつ、問題解決に役立つ情報を含める
- エラーログには詳細な情報を含めるが、ユーザーには簡潔なメッセージを表示する

