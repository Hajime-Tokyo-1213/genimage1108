
---

# 🧩 改修仕様書・要件定義書（ImageGenerator拡張計画）

## 1. 開発目的

生成AIを活用して「プロンプト→画像生成→再編集→選別→保存」までを一連で完結できるWebアプリを構築する。
ユーザーが試行錯誤的に画像を生成しながら、スタイルやプロンプトを再利用・改善できる環境を提供する。

---

## 2. 現状の仕様（v1）

| 機能        | 内容                              |
| --------- | ------------------------------- |
| プロンプト入力   | テキストボックスで入力した内容をImagen 4 APIに送信 |
| 画像生成      | 生成結果（Base64）を1枚表示               |
| エラーハンドリング | APIキー未設定や通信失敗時のメッセージ表示          |
| ダウンロード    | 生成画像を1枚ずつ保存可能                   |

---

## 3. 改修方針（v2〜v3段階構成）

### v2: 「生成→再生成・再プロンプト」対応

**目的:** 生成後にも再度プロンプトを変更して再生成できるようにする。

#### 要件

* 生成済み画像の下に「再生成」ボタンを追加
* ボタン押下で、同一セッション内で新しいプロンプトを入力できるテキストエリアを再表示
* 新しいプロンプトを既存画像と紐付けて「再生成履歴」をサイドパネルに蓄積

#### 実装概要

* `images` ステートを配列化 (`[{id, prompt, imageUrl, createdAt}, …]`)
* 各画像の再生成時には同じIDを継承し、新たな`revision`を生成
* 再生成履歴を右サイドパネルに追加

---

### v3: 「画像アップロード編集」機能

**目的:** 生成だけでなく、ユーザーがアップロードした画像を編集ベースとして扱う。

#### 要件

* 画像アップロードボタンをフォーム上部に追加
* アップロードされた画像を `referenced_image` としてAPIに送信
* promptに「この画像を〇〇風にして」と指定できるUI補助
* 編集結果も履歴に追加

#### 実装概要

* `input type="file"` を追加（`accept="image/*"`)
* Base64化してAPIリクエストに `image: { imageBytes: base64data }` を付与
* API呼び出し時、`instances`内で `prompt` + `image` を送信

---

### v4: 「サイドパネル（履歴一覧）」の実装

**目的:** 生成・再生成されたすべての画像を右側のサイドパネルに一覧表示。

#### 要件

* サイドパネルを固定レイアウト化（右側50%以下）
* 各画像にチェックボックスを付与
* チェックした画像のみ「まとめてダウンロード」
* 履歴順（新→旧）で表示
* hover時にプロンプトをツールチップ表示

#### 実装概要

* `images`配列をmapしてリスト描画
* `selectedImageIds`をState管理
* `Zip.js`を使用して一括DL（画像＋プロンプト.json）

---

### v5: 「プリセットプロンプト（スタイルライブラリ）」の導入

**目的:** よく使うスタイルを事前登録し、ドラッグ＆ドロップで適用。

#### 要件

* 左サイドパネルに「スタイル一覧」を表示
* 各スタイル: `{ id, name, prompt, thumbnail }`
* ドラッグで中央入力欄にドロップ → `prompt`に自動挿入
* スタイルの追加・削除も可能

#### 実装概要

* `react-dnd` ライブラリでドラッグ＆ドロップ対応
* スタイル情報を `localStorage` に保存（永続化）

---

### v6: 「注意書き・法務ガイド」挿入

**目的:** 利用者が安心して生成画像を扱えるようにする。

#### 要件

* 画面下部に以下の固定文言を常時表示：

```
⚠️ 注意事項:
生成される画像やプロンプトは、他者の著作権・肖像権を侵害しないようご利用ください。
本アプリでは、作成したプロンプトと画像を一緒に記録・保管することを推奨します。
```

* 生成ごとに `prompt` と `imageUrl` をJSONとしてローカルに保存可能に。

---

### v7: 「最終選別・保存」フェーズ

**目的:** 最後に「残したい画像」を選択してまとめて保存できる。

#### 要件

* サイドパネル内チェックボックスを使って複数選択
* 「選択した画像を保存」ボタンでZip出力
* Zip内構造：

  ```
  /exports/
     001.png
     001_prompt.txt
     002.png
     002_prompt.txt
  ```

---

## 4. 今後の追加アイデア（v8以降）

| 機能        | 概要                                 |
| --------- | ---------------------------------- |
| AIリミックス機能 | 既存画像＋新プロンプトで「スタイル転写」               |
| バッチ生成     | 複数プロンプトを一括生成                       |
| ギャラリーモード  | 生成履歴をスクロールギャラリーで表示                 |
| クラウド保存連携  | Google Drive / Firebase Storage 連携 |
| スタイル学習    | よく使うプロンプトの傾向を自動提案                  |

---

## 5. UIレイアウト構成（v3以降）

```
+-------------------------------------------------------------+
| 左サイド（スタイル）  | 中央メイン（生成UI） | 右サイド（履歴） |
|------------------------|--------------------|-------------------|
| 🎨 スタイル選択         | 📝 プロンプト入力     | 🖼️ 生成画像一覧     |
|  🔹 和風アート          | [生成ボタン]        | [チェックDL]       |
|  🔹 未来都市            | [再生成]            | [再生成履歴]       |
+-------------------------------------------------------------+
```

---

## 6. データ構造（React State）

```js
{
  prompt: string,
  imageUrl: string,
  createdAt: string,
  revision?: number,
  originalImage?: string, // アップロード元
}
```

---

## 7. 使用技術

| 分類          | 内容                                          |
| ----------- | ------------------------------------------- |
| Frontend    | React + Vite + Tailwind（またはCSS Modules）     |
| AI API      | Google Generative Language API (Imagen 4.0) |
| State管理     | useState / useReducer                       |
| ファイルDL      | JSZip / FileSaver                           |
| ストレージ       | localStorage（履歴・プリセット保持）                    |
| Drag & Drop | react-dnd                                   |
| 画像編集（拡張予定）  | Canvas API / Fabric.js                      |

---

## 8. 次ステップ提案

1️⃣ **v2 実装（再生成＋履歴管理）**
　→ 配列化・サイドパネルプロトタイプ作成
2️⃣ **v3（アップロード対応）**
　→ `imageBytes` 付きAPI呼び出し対応
3️⃣ **v4（一覧＋選別）**
　→ 一括ダウンロード機能まで構築

---
