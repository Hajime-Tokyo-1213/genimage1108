# 改修仕様書 1: 共通ユーティリティ関数の抽出と型定義の追加

## 目的
重複している`getEnvVar`関数を共通化し、型定義ファイルを作成して、TypeScript化の基盤を整備する。

## 背景
- `authService.js`と`supabaseClient.js`で`getEnvVar`関数が重複している
- 型定義が不足しており、TypeScript化の準備ができていない
- 共通のユーティリティ関数を一元管理する必要がある

## 実施内容

### 1. 共通ユーティリティファイルの作成
- **ファイル**: `src/utils/env.ts` を新規作成
- **内容**: 
  - `getEnvVar`関数を共通化
  - `resolveSiteUrl`関数も共通化
  - TypeScript型定義を追加

### 2. 型定義ファイルの作成
- **ファイル**: `src/types/index.ts` を新規作成
- **内容**:
  - 画像データの型定義（`ImageData`, `ImageHistory`, `ImageArchive`）
  - スタイルデータの型定義（`Style`, `StyleData`）
  - エラーの型定義（`AppError`, `ErrorWithCode`）
  - APIレスポンスの型定義

### 3. 既存ファイルの更新
- **`src/lib/supabaseClient.js`**:
  - `getEnvVar`と`resolveSiteUrl`を削除
  - `src/utils/env.ts`からインポート
  - 型定義を追加（`.ts`に変換は次回）

- **`src/lib/authService.js`**:
  - `getEnvVar`と`resolveSiteUrl`を削除
  - `src/utils/env.ts`からインポート
  - 型定義を追加（`.ts`に変換は次回）

## 実装詳細

### `src/utils/env.ts`
```typescript
/**
 * 環境変数を取得する共通関数
 * @param key - 環境変数のキー
 * @returns 環境変数の値、存在しない場合はundefined
 */
export const getEnvVar = (key: string): string | undefined => {
  if (typeof import.meta !== 'undefined' && import.meta.env && import.meta.env[key]) {
    return import.meta.env[key];
  }
  if (typeof process !== 'undefined' && process.env && process.env[key]) {
    return process.env[key];
  }
  return undefined;
};

/**
 * サイトURLを解決する共通関数
 * @returns サイトURL、解決できない場合はundefined
 */
export const resolveSiteUrl = (): string | undefined => {
  const envSiteUrl = getEnvVar('VITE_SITE_URL') || getEnvVar('SITE_URL');
  if (envSiteUrl) {
    return envSiteUrl.replace(/\/$/, '');
  }
  if (typeof window !== 'undefined' && window.location?.origin) {
    return window.location.origin;
  }
  return undefined;
};
```

### `src/types/index.ts`
```typescript
// 画像関連の型定義
export interface ImageData {
  id: string;
  prompt: string;
  thumbnailUrl?: string | null;
  fullImageUrl?: string | null;
  imageUrl?: string | null;
  createdAt: string;
  revision?: number;
  title?: string;
  saved?: boolean;
}

export interface ImageHistory extends ImageData {
  user_id: string;
}

export interface ImageArchive {
  id: string;
  user_id: string;
  prompt: string;
  image_base64: string | null;
  created_at: string;
  title: string;
}

// スタイル関連の型定義
export interface Style {
  id: string;
  name: string;
  prompt: string;
  thumbnail?: string | null;
  source?: string;
  createdAt: string;
  yaml?: Record<string, any> | null;
}

// エラー関連の型定義
export interface ErrorWithCode extends Error {
  code?: string;
  status?: number;
  details?: string;
  hint?: string;
}

export interface AppError {
  message: string;
  code?: string;
  details?: string;
  hint?: string;
}
```

## テスト要件
- `getEnvVar`関数が正しく環境変数を取得できることを確認
- `resolveSiteUrl`関数が正しくURLを解決できることを確認
- 既存の機能が壊れていないことを確認（手動テスト）

## 影響範囲
- `src/lib/supabaseClient.js`
- `src/lib/authService.js`
- 新規ファイル: `src/utils/env.ts`, `src/types/index.ts`

## 完了条件
- [ ] `src/utils/env.ts`が作成され、`getEnvVar`と`resolveSiteUrl`が実装されている
- [ ] `src/types/index.ts`が作成され、主要な型定義が追加されている
- [ ] `supabaseClient.js`と`authService.js`が共通関数を使用するように更新されている
- [ ] 既存の機能が正常に動作することを確認（ビルドエラーなし、動作確認）

## 注意事項
- 既存の機能を壊さないよう、慎重にリファクタリングを行う
- 型定義は段階的に追加し、既存のJavaScriptコードとの互換性を保つ
- ビルドが通ることを確認してからコミットする

