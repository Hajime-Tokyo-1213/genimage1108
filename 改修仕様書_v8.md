# 🧩 改修仕様書 v8: UI改善・機能拡張

## 1. 改修目的

画像保存の容量問題を解決し、UIの使いやすさを向上させる。また、プロンプトモードと画像生成モードの連携を強化する。

---

## 2. 改修項目一覧

| 項目 | 優先度 | 難易度 | 概要 |
|------|--------|--------|------|
| **F-01** 画像保存方式の変更 | 高 | 中 | サムネイルのみ表示、元画像はダウンロードで保存 |
| **F-02** スタイルライブラリのトグル表示 | 中 | 低 | タイトルのみ表示、クリックで展開 |
| **F-03** 生成画像のタイトル編集 | 中 | 低 | 画像にタイトルを付与・編集可能に |
| **F-04** 画像のクイックルック表示 | 高 | 中 | 画像選択時に拡大表示 |
| **F-05** プロンプト→スタイルライブラリ追加 | 中 | 低 | プロンプトモードで作成したプロンプトをスタイルに追加 |
| **F-06** 生成画像をスタイルサムネとして追加 | 中 | 中 | 生成画像をスタイルライブラリのサムネイルに設定 |
| **F-07** オブジェクト入力機能 | 高 | 中 | スタイル+オブジェクトでプロンプトを構築 |

---

## 3. 詳細仕様

### 3.1. 【F-01】画像保存方式の変更

#### 3.1.1. 目的
- localStorageの容量制限を回避
- アプリ内では軽量なサムネイルのみ表示
- 元画像はユーザーが明示的に保存する

#### 3.1.2. 要件

**データ構造の変更:**
```javascript
// 変更前
{
  id: string,
  prompt: string,
  imageUrl: string, // Base64フルサイズ画像
  createdAt: string,
  revision: number
}

// 変更後
{
  id: string,
  prompt: string,
  thumbnailUrl: string, // Base64サムネイル（200x200px程度）
  fullImageUrl: string, // Base64フルサイズ画像（一時保存のみ）
  createdAt: string,
  revision: number,
  title: string, // タイトル（F-03で追加）
  saved: boolean // 保存済みフラグ
}
```

**保存ロジック:**
1. 画像生成時:
   - フルサイズ画像を一時的にメモリに保持（`fullImageUrl`）
   - サムネイル（200x200px、JPEG品質70%）を生成して`thumbnailUrl`に保存
   - localStorageにはサムネイルのみ保存（最大10枚まで）

2. ダウンロード時:
   - ユーザーが「ダウンロード」ボタンをクリック
   - ブラウザのファイル保存ダイアログを表示
   - フルサイズ画像を保存（`generated-image-{id}.png`）
   - 保存後、`saved: true`フラグを設定（任意）

3. 一括ダウンロード時:
   - 選択した画像をZIPファイルにまとめてダウンロード
   - 保存先フォルダを選択可能（ブラウザの標準機能）

#### 3.1.3. 実装詳細

**サムネイル生成関数:**
```javascript
const generateThumbnail = (imageUrl, maxSize = 200) => {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // アスペクト比を維持してリサイズ
      const ratio = Math.min(maxSize / img.width, maxSize / img.height);
      canvas.width = img.width * ratio;
      canvas.height = img.height * ratio;
      
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      const thumbnail = canvas.toDataURL('image/jpeg', 0.7);
      resolve(thumbnail);
    };
    img.src = imageUrl;
  });
};
```

**localStorage保存ロジック:**
- サムネイルのみ保存（最新10枚まで）
- フルサイズ画像はメモリ上のみ保持
- ページリロード時は、フルサイズ画像は失われる（サムネイルのみ復元）

**UI変更:**
- 履歴一覧ではサムネイルのみ表示
- 各画像に「💾 保存」ボタンを追加
- 保存済み画像には「✓ 保存済み」バッジを表示（任意）

---

### 3.2. 【F-02】スタイルライブラリのトグル表示

#### 3.2.1. 目的
- 画面スペースを節約
- 必要な時だけ詳細を表示

#### 3.2.2. 要件

**UI構造:**
```
🎨 スタイルライブラリ [+ 追加]
├─ ▼ 和風アート
│  └─ [サムネイル] [適用] [編集] [削除]
├─ ▼ 未来都市
│  └─ [サムネイル] [適用] [編集] [削除]
└─ ▼ ファンタジー
   └─ [サムネイル] [適用] [編集] [削除]
```

**動作:**
1. 初期状態: タイトルのみ表示（▶ アイコン）
2. クリック: 展開してサムネイルとボタンを表示（▼ アイコン）
3. 再クリック: 折りたたみ

**データ構造の拡張:**
```javascript
{
  id: string,
  name: string,
  prompt: string,
  thumbnail: string | null, // サムネイル画像（F-06で追加可能）
  isExpanded: boolean // トグル状態（UI状態のみ、保存不要）
}
```

#### 3.2.3. 実装詳細

**コンポーネント構造:**
```jsx
<div className="style-item">
  <div 
    className="style-item-header"
    onClick={() => toggleStyle(style.id)}
  >
    <span className="toggle-icon">
      {isExpanded ? '▼' : '▶'}
    </span>
    <h3>{style.name}</h3>
  </div>
  {isExpanded && (
    <div className="style-item-content">
      {style.thumbnail && (
        <img src={style.thumbnail} alt={style.name} />
      )}
      <p className="style-prompt-preview">{style.prompt}</p>
      <div className="style-item-actions">
        <button onClick={() => handleStyleClick(style.prompt)}>適用</button>
        <button onClick={() => handleEditStyle(style.id)}>編集</button>
        <button onClick={() => handleDeleteStyle(style.id)}>削除</button>
      </div>
    </div>
  )}
</div>
```

---

### 3.3. 【F-03】生成画像のタイトル編集

#### 3.3.1. 目的
- 画像を識別しやすくする
- 検索・整理の利便性向上

#### 3.3.2. 要件

**UI:**
- 履歴一覧の各画像にタイトル表示エリアを追加
- タイトルをクリック/ダブルクリックで編集モードに
- 編集後、Enterキーまたは外部クリックで確定

**データ構造:**
```javascript
{
  // ... 既存フィールド
  title: string, // デフォルト: 生成日時または空文字
}
```

**デフォルトタイトル:**
- 初回生成時: `画像 {日時}` または空文字
- ユーザーが編集可能

#### 3.3.3. 実装詳細

**編集UI:**
```jsx
<div className="history-item-title">
  {editingTitleId === img.id ? (
    <input
      type="text"
      value={editingTitle}
      onChange={(e) => setEditingTitle(e.target.value)}
      onBlur={() => handleSaveTitle(img.id)}
      onKeyDown={(e) => {
        if (e.key === 'Enter') handleSaveTitle(img.id);
        if (e.key === 'Escape') setEditingTitleId(null);
      }}
      autoFocus
    />
  ) : (
    <span 
      onClick={() => handleStartEditTitle(img.id, img.title)}
      className="title-editable"
    >
      {img.title || `画像 ${new Date(img.createdAt).toLocaleString('ja-JP')}`}
    </span>
  )}
</div>
```

---

### 3.4. 【F-04】画像のクイックルック表示

#### 3.4.1. 目的
- 画像の全容を確認できるようにする
- モーダルまたはサイドパネルで拡大表示

#### 3.4.2. 要件

**表示方法（2つの選択肢）:**

**オプションA: モーダル表示（推奨）**
- 画像をクリックすると、画面中央にモーダルで拡大表示
- 背景は半透明のオーバーレイ
- ESCキーまたは背景クリックで閉じる

**オプションB: 右側拡大パネル**
- 画像をクリックすると、右側に拡大パネルを表示
- 既存の履歴一覧の上に重ねて表示

**表示内容:**
- フルサイズ画像（可能な限り大きく）
- タイトル
- プロンプト全文
- 生成日時
- ダウンロードボタン
- 再生成ボタン

#### 3.4.3. 実装詳細（オプションA: モーダル）

```jsx
{quickLookImage && (
  <div 
    className="quick-look-modal"
    onClick={(e) => {
      if (e.target === e.currentTarget) setQuickLookImage(null);
    }}
  >
    <div className="quick-look-content">
      <button 
        className="close-button"
        onClick={() => setQuickLookImage(null)}
      >
        ×
      </button>
      <img src={quickLookImage.fullImageUrl} alt={quickLookImage.title} />
      <div className="quick-look-info">
        <h3>{quickLookImage.title}</h3>
        <p className="prompt">{quickLookImage.prompt}</p>
        <p className="date">{new Date(quickLookImage.createdAt).toLocaleString('ja-JP')}</p>
        <div className="quick-look-actions">
          <button onClick={() => handleDownload(quickLookImage.id)}>
            💾 ダウンロード
          </button>
          <button onClick={() => handleRegenerate(quickLookImage.id)}>
            🔄 再生成
          </button>
        </div>
      </div>
    </div>
  </div>
)}
```

**キーボード操作:**
- ESC: モーダルを閉じる
- ← →: 前後の画像に移動（任意）

---

### 3.5. 【F-05】プロンプト→スタイルライブラリ追加

#### 3.5.1. 目的
- プロンプトモードで作成したプロンプトを再利用可能にする
- 画像生成モードで簡単に適用できるようにする

#### 3.5.2. 要件

**プロンプトモード側:**
- テンプレート設定画面に「スタイルライブラリに追加」ボタンを追加
- クリックすると、現在のプロンプト（`generatePromptFromYaml`の結果）をスタイルとして保存

**画像生成モード側:**
- スタイルライブラリに追加されたプロンプトが表示される
- 通常のスタイルと同様に適用可能

**データ構造:**
```javascript
{
  id: string,
  name: string, // テンプレート名または「プロンプト {日時}」
  prompt: string, // 生成されたプロンプト文字列
  thumbnail: string | null,
  source: 'manual' | 'prompt-mode', // 出所を記録
  createdAt: string
}
```

#### 3.5.3. 実装詳細

**プロンプトモード側の追加:**
```jsx
<button 
  onClick={handleAddToStyleLibrary}
  className="add-to-style-button"
>
  📚 スタイルライブラリに追加
</button>
```

**処理フロー:**
1. プロンプトモードで「スタイルライブラリに追加」をクリック
2. テンプレート名を入力（デフォルト: 現在のテンプレート名）
3. 現在のYAMLからプロンプトを生成（`generatePromptFromYaml`）
4. スタイルライブラリに追加
5. 画像生成モードに切り替えて確認可能

---

### 3.6. 【F-06】生成画像をスタイルサムネとして追加

#### 3.6.1. 目的
- 生成した画像をスタイルの視覚的なサムネイルとして使用
- スタイルライブラリの視認性向上

#### 3.6.2. 要件

**画像生成モード側:**
- 生成画像のクイックルックまたは履歴一覧に「スタイルのサムネとして使用」ボタンを追加
- クリックすると、スタイル選択ダイアログを表示
- 既存スタイルを選択するか、新規スタイルを作成してサムネイルを設定

**スタイルライブラリ側:**
- サムネイルが設定されているスタイルは、トグル展開時にサムネイルを表示
- サムネイルをクリックすると、そのスタイルを適用

#### 3.6.3. 実装詳細

**UI追加:**
```jsx
// クイックルックまたは履歴アイテムに追加
<button 
  onClick={() => handleSetAsStyleThumbnail(img.id)}
  className="set-thumbnail-button"
>
  🖼️ スタイルのサムネとして使用
</button>
```

**処理フロー:**
1. 「スタイルのサムネとして使用」をクリック
2. スタイル選択モーダルを表示
   - 既存スタイル一覧
   - 「新規スタイルを作成」オプション
3. スタイルを選択/作成
4. 選択した画像のサムネイル（200x200px）を生成
5. スタイルデータに`thumbnail`を設定

**データ更新:**
```javascript
// スタイルデータにサムネイルを追加
const updatedStyle = {
  ...selectedStyle,
  thumbnail: thumbnailBase64 // 200x200pxのサムネイル
};
```

---

### 3.7. 【F-07】オブジェクト入力機能

#### 3.7.1. 目的
- スタイルとオブジェクト（人物、背景など）を分離して入力
- より柔軟なプロンプト構築

#### 3.7.2. 要件

**UI構成:**
```
[スタイル選択] ← スタイルライブラリから選択
[オブジェクト入力] ← 自由記入欄
  - 人物: [入力欄]
  - 背景: [入力欄]
  - その他: [入力欄]

[生成プロンプトプレビュー]
  「{選択したスタイルのプロンプト}, {人物入力}, {背景入力}, {その他入力}」

[画像を生成]
```

**プロンプト構築ロジック:**
1. スタイルライブラリからスタイルを選択 → `stylePrompt`
2. オブジェクト入力欄に入力 → `objectInputs`
3. 最終プロンプト = `${stylePrompt}, ${objectInputs.person}, ${objectInputs.background}, ${objectInputs.other}`

#### 3.7.3. 実装詳細

**State追加:**
```javascript
const [selectedStyleId, setSelectedStyleId] = useState(null);
const [objectInputs, setObjectInputs] = useState({
  person: '',
  background: '',
  other: ''
});
```

**UI追加:**
```jsx
<div className="prompt-builder">
  <div className="style-selector">
    <label>スタイル</label>
    <select 
      value={selectedStyleId || ''}
      onChange={(e) => setSelectedStyleId(e.target.value)}
    >
      <option value="">スタイルを選択...</option>
      {styles.map(style => (
        <option key={style.id} value={style.id}>
          {style.name}
        </option>
      ))}
    </select>
  </div>

  <div className="object-inputs">
    <div className="object-input-group">
      <label>人物</label>
      <input
        type="text"
        value={objectInputs.person}
        onChange={(e) => setObjectInputs({
          ...objectInputs,
          person: e.target.value
        })}
        placeholder="例: 若い女性、長い髪、笑顔"
      />
    </div>
    
    <div className="object-input-group">
      <label>背景</label>
      <input
        type="text"
        value={objectInputs.background}
        onChange={(e) => setObjectInputs({
          ...objectInputs,
          background: e.target.value
        })}
        placeholder="例: 夕日の海辺、雲一つない空"
      />
    </div>
    
    <div className="object-input-group">
      <label>その他</label>
      <input
        type="text"
        value={objectInputs.other}
        onChange={(e) => setObjectInputs({
          ...objectInputs,
          other: e.target.value
        })}
        placeholder="例: カメラアングル、構図など"
      />
    </div>
  </div>

  <div className="prompt-preview">
    <label>生成プロンプト</label>
    <textarea
      value={buildFinalPrompt()}
      readOnly
      rows={3}
    />
  </div>
</div>
```

**プロンプト構築関数:**
```javascript
const buildFinalPrompt = () => {
  const parts = [];
  
  // スタイル
  if (selectedStyleId) {
    const style = styles.find(s => s.id === selectedStyleId);
    if (style) parts.push(style.prompt);
  }
  
  // オブジェクト
  if (objectInputs.person) parts.push(objectInputs.person);
  if (objectInputs.background) parts.push(objectInputs.background);
  if (objectInputs.other) parts.push(objectInputs.other);
  
  return parts.join(', ');
};
```

**既存のプロンプト入力欄との関係:**
- オブジェクト入力機能を使用する場合: プロンプト入力欄は非表示または無効化
- 従来の直接入力も可能: トグルで切り替え可能

---

## 4. データ構造の変更まとめ

### 4.1. 画像データ
```javascript
{
  id: string,
  prompt: string,
  thumbnailUrl: string, // 新規: サムネイル（200x200px）
  fullImageUrl: string, // 変更: 一時保存のみ
  createdAt: string,
  revision: number,
  title: string, // 新規: タイトル
  saved: boolean // 新規: 保存済みフラグ（任意）
}
```

### 4.2. スタイルデータ
```javascript
{
  id: string,
  name: string,
  prompt: string,
  thumbnail: string | null, // 新規: サムネイル画像
  source: 'manual' | 'prompt-mode', // 新規: 出所
  createdAt: string
}
```

---

## 5. UIレイアウト変更

### 5.1. 画像生成モード

```
+-------------------------------------------------------------+
| 左サイド（スタイル）  | 中央メイン（生成UI） | 右サイド（履歴） |
|------------------------|--------------------|-------------------|
| 🎨 スタイルライブラリ    | 📝 プロンプト構築   | 🖼️ 生成画像一覧    |
| [+ 追加]               |                    |                   |
| ▼ 和風アート           | [スタイル選択]      | [サムネ] タイトル  |
|  [サムネ] [適用]       | [人物入力]         | [サムネ] タイトル  |
|                        | [背景入力]         |                   |
| ▶ 未来都市             | [その他入力]       |                   |
|                        |                    |                   |
| ▶ ファンタジー         | [プロンプトプレビュー]|                  |
|                        |                    |                   |
|                        | [画像を生成]       |                   |
+-------------------------------------------------------------+
```

### 5.2. クイックルックモーダル

```
+-------------------------------------------------------------+
|                    [× 閉じる]                               |
|                                                             |
|              [拡大表示された画像]                            |
|                                                             |
|  タイトル: 画像 2024/01/01 12:00                            |
|  プロンプト: ...                                            |
|  生成日時: 2024/01/01 12:00                                |
|                                                             |
|  [💾 ダウンロード] [🔄 再生成]                              |
+-------------------------------------------------------------+
```

---

## 6. 実装順序の推奨

1. **F-01** 画像保存方式の変更（最優先）
   - 容量問題の根本解決
   
2. **F-04** 画像のクイックルック表示
   - ユーザビリティ向上
   
3. **F-03** 生成画像のタイトル編集
   - クイックルックと同時実装が効率的
   
4. **F-02** スタイルライブラリのトグル表示
   - UI改善
   
5. **F-07** オブジェクト入力機能
   - 機能拡張
   
6. **F-05** プロンプト→スタイルライブラリ追加
   - 連携機能
   
7. **F-06** 生成画像をスタイルサムネとして追加
   - 最後に実装（F-05とF-02が前提）

---

## 7. 技術的な注意点

### 7.1. サムネイル生成
- Canvas APIを使用
- ブラウザ互換性に注意（IE非対応）
- 画像の読み込みは非同期処理

### 7.2. ファイルダウンロード
- `file-saver`ライブラリを使用（既存）
- ブラウザのファイル保存ダイアログは標準機能を使用
- ZIPファイルの生成は`jszip`を使用（既存）

### 7.3. モーダル表示
- オーバーレイのz-indexに注意
- ESCキーイベントのハンドリング
- フォーカストラップ（アクセシビリティ）

### 7.4. localStorage容量管理
- サムネイルのみ保存（10枚まで）
- 容量超過時のエラーハンドリング
- 古いデータの自動削除

---

## 8. テスト項目

### 8.1. F-01 画像保存方式
- [ ] サムネイルが正しく生成される
- [ ] localStorageにサムネイルのみ保存される
- [ ] ダウンロードボタンでフルサイズ画像が保存される
- [ ] 一括ダウンロードでZIPファイルが生成される

### 8.2. F-02 スタイルライブラリトグル
- [ ] 初期状態でタイトルのみ表示
- [ ] クリックで展開/折りたたみが動作
- [ ] 複数のスタイルを個別に展開可能

### 8.3. F-03 タイトル編集
- [ ] タイトルをクリックで編集モード
- [ ] Enterキーで確定
- [ ] ESCキーでキャンセル
- [ ] 編集内容が保存される

### 8.4. F-04 クイックルック
- [ ] 画像クリックでモーダル表示
- [ ] ESCキーで閉じる
- [ ] 背景クリックで閉じる
- [ ] フルサイズ画像が表示される

### 8.5. F-05 プロンプト→スタイル追加
- [ ] プロンプトモードからスタイルライブラリに追加可能
- [ ] 追加されたスタイルが画像生成モードで表示される
- [ ] スタイルが正しく適用される

### 8.6. F-06 画像をサムネとして追加
- [ ] 生成画像からスタイルのサムネイルを設定可能
- [ ] サムネイルがスタイルライブラリに表示される

### 8.7. F-07 オブジェクト入力
- [ ] スタイル選択が動作する
- [ ] オブジェクト入力がプロンプトに反映される
- [ ] プロンプトプレビューが正しく表示される

---

## 9. 今後の拡張アイデア

- 画像検索機能（タイトル・プロンプトで検索）
- 画像のタグ付け機能
- スタイルのカテゴリ分類
- プロンプトの履歴管理
- 画像の比較表示機能

---

以上、改修仕様書 v8 です。

