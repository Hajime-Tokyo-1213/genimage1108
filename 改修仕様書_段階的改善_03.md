# 改修仕様書 3: supabaseClient.js の TypeScript 化

## 目的
`supabaseClient.js`をTypeScriptに変換し、型安全性を向上させる。

## 背景
- `supabaseClient.js`は重要な基盤ファイルだが、JavaScriptのまま
- 型定義がないため、型安全性が確保されていない
- 共通ユーティリティ関数の抽出が完了しているため、TypeScript化の準備が整っている

## 実施内容

### 1. ファイルの変換
- **ファイル**: `src/lib/supabaseClient.js` → `src/lib/supabaseClient.ts`
- **内容**:
  - 型定義の追加
  - 共通ユーティリティ関数のインポート
  - Supabaseクライアントの型定義

### 2. 型定義の追加
- Supabaseクライアントの型
- セッションの型
- エラーの型

### 3. インポート元の更新
- `src/lib/authService.js`のインポートパスを更新
- その他、`supabaseClient.js`をインポートしているファイルを更新

## 実装詳細

### `src/lib/supabaseClient.ts`
```typescript
import { createClient, SupabaseClient, Session } from '@supabase/supabase-js';
import { getEnvVar } from '../utils/env';
import { ErrorWithCode } from '../types';

const supabaseUrl = getEnvVar('VITE_SUPABASE_URL');
const supabaseAnonKey = getEnvVar('VITE_SUPABASE_ANON_KEY');

if (!supabaseUrl) {
  throw new Error('VITE_SUPABASE_URL is not defined');
}

if (!supabaseAnonKey) {
  throw new Error('VITE_SUPABASE_ANON_KEY is not defined');
}

export const supabase: SupabaseClient = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
    storageKey: 'sb_session',
  },
});

/**
 * セッションを取得する（セッションが存在しない場合はエラーをスロー）
 * @param client - Supabaseクライアント（デフォルト: supabase）
 * @returns セッション
 * @throws セッションが存在しない場合、またはエラーが発生した場合
 */
export const requireSession = async (client: SupabaseClient = supabase): Promise<Session> => {
  const { data, error } = await client.auth.getSession();
  
  if (error) {
    const err: ErrorWithCode = new Error(error.message || 'セッションの取得に失敗しました');
    err.code = error.name;
    throw err;
  }
  
  if (!data.session) {
    const err: ErrorWithCode = new Error('この操作にはログインが必要です');
    err.status = 401;
    throw err;
  }
  
  return data.session;
};

export default supabase;
```

### インポート元の更新例
- `src/lib/authService.js`: `import { supabase, requireSession } from './supabaseClient.js';` → `import { supabase, requireSession } from './supabaseClient';`
- その他のファイルも同様に更新

## テスト要件
- TypeScriptのコンパイルエラーがないことを確認
- 既存の機能が正常に動作することを確認
- 型チェックが正しく機能することを確認

## 影響範囲
- `src/lib/supabaseClient.js` → `src/lib/supabaseClient.ts`
- `src/lib/authService.js`（インポートパスの更新）
- `src/contexts/AuthContext.tsx`（インポートパスの更新）
- `src/components/AuthCallback.jsx`（インポートパスの更新）
- その他、`supabaseClient.js`をインポートしているすべてのファイル

## 完了条件
- [ ] `src/lib/supabaseClient.ts`が作成され、型定義が追加されている
- [ ] すべてのインポート元が更新されている
- [ ] TypeScriptのコンパイルエラーがない
- [ ] 既存の機能が正常に動作することを確認
- [ ] 型チェックが正しく機能することを確認

## 注意事項
- 既存の機能を壊さないよう、慎重に変換を行う
- 型定義は段階的に追加し、既存のJavaScriptコードとの互換性を保つ
- ビルドが通ることを確認してからコミットする
- インポートパスの更新漏れがないよう、すべてのファイルを確認する

