# プロンプト解析精度改善策

## 問題の原因

プロンプトをYAMLに変換する際の精度が低い原因は、**systemPromptが不十分**だったことです。

### 以前の問題点

1. **基本構造のみ要求**: 以前のsystemPromptは、format, background, subject, style, mood, typography という基本的な構造しか要求していませんでした
2. **詳細情報の欠落**: attire_policy, hair_tone_lock, pose_and_framing, palette, lighting_mood, styling_keywords, quality_flags, optional_midjourney, optional_negative_tokens などの詳細なセクションが全く含まれていませんでした
3. **例示の欠如**: 期待される出力形式を示す例（Few-shot learning）がありませんでした

## 実施した改善策

### 1. systemPromptの大幅な拡張

以下の13のセクションを明確に定義しました：

1. **subject** (被写体) - description, gender, age
2. **style** (スタイル) - description, type, technique, aesthetic
3. **attire_policy** (服装ポリシー) - allowed, forbidden
4. **hair_tone_lock** (髪色ロック) - base_color, mid_glaze, depth_hint, highlight_max, rule
5. **pose_and_framing** (ポーズとフレーミング) - shot, angle, posture, hands, contrast
6. **palette** (パレット) - skin, hair, clothing_washes, saturation, negative_space
7. **lighting_mood** (照明とムード) - type, rim_light, atmosphere
8. **background** (背景) - type, color, description, strokes, layout
9. **styling_keywords** (スタイリングキーワード) - キーワードのリスト
10. **quality_flags** (品質フラグ) - 品質フラグのリスト
11. **format** (フォーマット) - aspectRatio, style, quality, stylize
12. **optional_midjourney** (Midjourney固有) - prompt_suffix, params
13. **optional_negative_tokens** (ネガティブトークン) - ネガティブトークンのリスト

### 2. Few-shot Learningの追加

期待される出力形式を示す具体例を追加しました。これにより、モデルが期待される詳細さと構造を理解できるようになります。

例として、改修仕様書に記載されている「JAPANESE WATERCOLOR MINIMAL - v2.2」プロンプトの完全な構造化例を提供しています。

### 3. 温度パラメータの調整

- **以前**: temperature: 0.3
- **改善後**: temperature: 0.2

構造化タスクのため、より低い温度で一貫性を向上させました。

### 4. モデル選択の柔軟性

環境変数 `VITE_OPENAI_MODEL` でモデルを切り替え可能にしました。

- **デフォルト**: `gpt-4o-mini`（コスト効率重視）
- **推奨（高精度が必要な場合）**: `gpt-4o`（より強力な解析能力）

## 使用方法

### 基本的な使用

現在の実装で、プロンプトモードでマスタープロンプトを入力すると、改善されたsystemPromptとFew-shot learningの例を使用して、より詳細な構造化が行われます。

### より高精度な解析が必要な場合

`.env` ファイルに以下を追加して、より強力なモデルを使用できます：

```env
VITE_OPENAI_MODEL=gpt-4o
```

**注意**: `gpt-4o` は `gpt-4o-mini` よりも高精度ですが、コストが高くなります。

## 期待される改善効果

1. **詳細情報の抽出**: プロンプト内のすべての詳細情報（HEXコード、リスト、技術的パラメータなど）が適切に抽出されます
2. **構造化の精度向上**: セクション名（例: "ATTIRE POLICY", "HAIR TONE LOCK"）を認識し、適切なセクションに配置されます
3. **一貫性の向上**: Few-shot learningの例により、期待される出力形式が明確になります

## テスト方法

1. プロンプトモードで、改修仕様書に記載されている「JAPANESE WATERCOLOR MINIMAL - v2.2」プロンプトを入力
2. 「テンプレート生成」ボタンをクリック
3. 生成されたYAML構造を確認し、以下のセクションが含まれているか確認：
   - attire_policy
   - hair_tone_lock
   - pose_and_framing
   - palette
   - styling_keywords
   - quality_flags
   - optional_midjourney
   - optional_negative_tokens

## さらなる改善の可能性

もし精度がまだ不十分な場合は、以下の追加改善を検討できます：

1. **段階的解析**: まず全体構造を抽出し、次に各セクションの詳細を抽出する2段階アプローチ
2. **プロンプト前処理**: プロンプトを正規化し、セクション名を明確に識別する前処理
3. **後処理**: 生成されたJSONを検証し、不足している情報を補完する後処理

## まとめ

問題の原因は**systemPromptの不十分さ**でした。今回の改善により：

- ✅ 詳細な構造を要求するsystemPromptに拡張
- ✅ Few-shot learningの例を追加
- ✅ 温度パラメータを最適化
- ✅ モデル選択の柔軟性を追加

これにより、プロンプト解析の精度が大幅に向上することが期待されます。

