# 改修仕様書 5: ImageGenerator のカスタムフック抽出（画像生成ロジック）

## 目的
`ImageGenerator.jsx`から画像生成関連のロジックをカスタムフックに抽出し、コンポーネントの責務を分離する。

## 背景
- `ImageGenerator.jsx`が3,500行超と巨大で、複数の責務が混在している
- 画像生成ロジックがコンポーネント内に直接実装されており、テストが困難
- 再利用性が低い

## 実施内容

### 1. カスタムフックの作成
- **ファイル**: `src/hooks/useImageGeneration.ts` を新規作成
- **内容**:
  - 画像生成API呼び出しロジック
  - 画像生成状態管理
  - エラーハンドリング

### 2. 画像生成サービスの作成
- **ファイル**: `src/services/imageGenerationService.ts` を新規作成
- **内容**:
  - Gemini API呼び出し
  - Imagen API呼び出し
  - APIレスポンスの処理

### 3. ImageGenerator.jsx の更新
- 画像生成ロジックをカスタムフックに置き換え
- コンポーネントはUI表示に集中

## 実装詳細

### `src/services/imageGenerationService.ts`
```typescript
interface GenerateImageParams {
  prompt: string;
  mode: 'new' | 'edit';
  uploadedImage?: string | null;
  apiKey: string;
}

interface ImageGenerationResponse {
  imageUrl: string;
  base64Data: string;
}

/**
 * 画像を生成する
 */
export const generateImage = async (params: GenerateImageParams): Promise<ImageGenerationResponse> => {
  const { prompt, mode, uploadedImage, apiKey } = params;
  
  if (!prompt.trim()) {
    throw new Error('プロンプトを入力してください');
  }
  
  if (mode === 'edit' && !uploadedImage) {
    throw new Error('画像を修正する場合は、画像をアップロードしてください');
  }
  
  let endpoint: string;
  let body: any;
  
  if (mode === 'edit' && uploadedImage) {
    // Gemini 2.5 Flash Image APIを使用（画像編集）
    endpoint = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:predict';
    body = {
      instances: [{
        prompt: prompt,
        image: {
          bytesBase64Encoded: uploadedImage
        }
      }],
      parameters: {
        sampleCount: 1,
        aspectRatio: '1:1'
      }
    };
  } else {
    // Imagen 4 APIを使用（新規作成）
    endpoint = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict';
    body = {
      instances: [{
        prompt: prompt,
      }],
      parameters: {
        sampleCount: 1,
        aspectRatio: '1:1'
      }
    };
  }
  
  const response = await fetch(endpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-goog-api-key': apiKey,
    },
    body: JSON.stringify(body),
  });
  
  if (!response.ok) {
    let errorData: any = {};
    try {
      const text = await response.text();
      errorData = JSON.parse(text);
    } catch {
      errorData = { error: { message: `HTTP ${response.status}: ${response.statusText}` } };
    }
    throw new Error(errorData.error?.message || `APIエラー: ${response.status}`);
  }
  
  const data = await response.json();
  
  // レスポンスから画像データを抽出
  let imageUrl: string;
  let base64Data: string;
  
  if (mode === 'edit' && data.predictions?.[0]?.bytesBase64Encoded) {
    base64Data = data.predictions[0].bytesBase64Encoded;
    imageUrl = `data:image/png;base64,${base64Data}`;
  } else if (data.predictions?.[0]?.bytesBase64Encoded) {
    base64Data = data.predictions[0].bytesBase64Encoded;
    imageUrl = `data:image/png;base64,${base64Data}`;
  } else {
    throw new Error('画像データが取得できませんでした');
  }
  
  return { imageUrl, base64Data };
};
```

### `src/hooks/useImageGeneration.ts`
```typescript
import { useState, useCallback } from 'react';
import { generateImage as generateImageService } from '../services/imageGenerationService';
import { handleError, logError } from '../utils/errorHandler';
import { ImageData } from '../types';

interface UseImageGenerationOptions {
  onSuccess?: (image: ImageData) => void;
  onError?: (error: string) => void;
}

export const useImageGeneration = (options: UseImageGenerationOptions = {}) => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  const generate = useCallback(async (
    prompt: string,
    mode: 'new' | 'edit',
    uploadedImage?: string | null
  ) => {
    setLoading(true);
    setError(null);
    
    try {
      const apiKey = import.meta.env.VITE_GEMINI_API_KEY;
      if (!apiKey) {
        throw new Error('APIキーが設定されていません。.env に VITE_GEMINI_API_KEY=... を設定してください。');
      }
      
      const result = await generateImageService({
        prompt,
        mode,
        uploadedImage,
        apiKey,
      });
      
      const newImage: ImageData = {
        id: generateUUID(),
        prompt,
        imageUrl: result.imageUrl,
        fullImageUrl: result.imageUrl,
        createdAt: new Date().toISOString(),
        revision: 0,
        title: '',
        saved: false,
      };
      
      if (options.onSuccess) {
        options.onSuccess(newImage);
      }
      
      return newImage;
    } catch (err) {
      const errorMessage = handleError(err, { component: 'useImageGeneration', action: 'generate' });
      setError(errorMessage);
      
      if (options.onError) {
        options.onError(errorMessage);
      }
      
      throw err;
    } finally {
      setLoading(false);
    }
  }, [options]);
  
  return {
    generate,
    loading,
    error,
  };
};

// UUID生成関数（共通化が必要な場合は別ファイルに移動）
const generateUUID = (): string => {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
};
```

### `src/ImageGenerator.jsx` の更新例
```javascript
// 既存の generateImage 関数を削除し、カスタムフックを使用
import { useImageGeneration } from './hooks/useImageGeneration';

const ImageGenerator = () => {
  // ... 既存のstate定義 ...
  
  const { generate: generateImage, loading: generationLoading, error: generationError } = useImageGeneration({
    onSuccess: async (image) => {
      // 成功時の処理
      setImages(prev => [image, ...prev]);
      setCurrentImageId(image.id);
      // 履歴保存などの処理
    },
    onError: (errorMessage) => {
      setError(errorMessage);
    },
  });
  
  // generateImage 関数の呼び出しを更新
  const handleSubmit = (e) => {
    e.preventDefault();
    generateImage(prompt, mode, uploadedImage);
  };
  
  // ... 残りのコンポーネント ...
};
```

## テスト要件
- カスタムフックが正しく動作することを確認
- 画像生成サービスが正しくAPIを呼び出すことを確認
- エラーハンドリングが正しく機能することを確認
- 既存の機能が壊れていないことを確認

## 影響範囲
- `src/ImageGenerator.jsx`（画像生成ロジックの削除とカスタムフックの使用）
- 新規ファイル: `src/hooks/useImageGeneration.ts`, `src/services/imageGenerationService.ts`

## 完了条件
- [ ] `src/services/imageGenerationService.ts`が作成され、画像生成API呼び出しが実装されている
- [ ] `src/hooks/useImageGeneration.ts`が作成され、カスタムフックが実装されている
- [ ] `ImageGenerator.jsx`がカスタムフックを使用するように更新されている
- [ ] 既存の機能が正常に動作することを確認
- [ ] エラーハンドリングが正しく機能することを確認

## 注意事項
- 既存の機能を壊さないよう、慎重にリファクタリングを行う
- カスタムフックのテストを追加することを推奨（次回以降の改修で実施）
- 画像生成のロジックが正しく動作することを十分に確認する
- APIキーの取得方法が変わらないことを確認する

