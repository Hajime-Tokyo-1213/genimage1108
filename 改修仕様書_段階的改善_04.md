# æ”¹ä¿®ä»•æ§˜æ›¸ 4: authService.js ã® TypeScript åŒ–

## ç›®çš„
`authService.js`ã‚’TypeScriptã«å¤‰æ›ã—ã€å‹å®‰å…¨æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã€‚

## èƒŒæ™¯
- `authService.js`ã¯èªè¨¼é–¢é€£ã®é‡è¦ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’å«ã‚€ãŒã€JavaScriptã®ã¾ã¾
- å‹å®šç¾©ãŒãªã„ãŸã‚ã€å‹å®‰å…¨æ€§ãŒç¢ºä¿ã•ã‚Œã¦ã„ãªã„
- `supabaseClient.ts`ã®å¤‰æ›ãŒå®Œäº†ã—ã¦ã„ã‚‹ãŸã‚ã€ä¾å­˜é–¢ä¿‚ãŒæ•´ã£ã¦ã„ã‚‹

## å®Ÿæ–½å†…å®¹

### 1. ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `src/lib/authService.js` â†’ `src/lib/authService.ts`
- **å†…å®¹**:
  - å‹å®šç¾©ã®è¿½åŠ 
  - å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€åŒ–

### 2. å‹å®šç¾©ã®è¿½åŠ 
- é–¢æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨æˆ»ã‚Šå€¤ã®å‹
- ç”»åƒãƒ‡ãƒ¼ã‚¿ã®å‹
- ã‚¹ã‚¿ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å‹
- ã‚¨ãƒ©ãƒ¼ã®å‹

### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€åŒ–
- æ–°ã—ã„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½¿ç”¨

### 4. ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã®æ›´æ–°
- `authService.js`ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°

## å®Ÿè£…è©³ç´°

### `src/lib/authService.ts`
```typescript
import { SupabaseClient, Session } from '@supabase/supabase-js';
import { supabase, requireSession } from './supabaseClient';
import { getEnvVar, resolveSiteUrl } from '../utils/env';
import { handleError, logError } from '../utils/errorHandler';
import { ImageData, Style, ErrorWithCode } from '../types';

/**
 * èªè¨¼æƒ…å ±ã‚’æ¤œè¨¼ã™ã‚‹
 */
const ensureCredentials = (email: string, password: string): void => {
  if (!email || !password) {
    throw new Error('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  }
};

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³
 */
export const loginUser = async (
  email: string,
  password: string,
  client: SupabaseClient = supabase
) => {
  ensureCredentials(email, password);
  return client.auth.signInWithPassword({ email, password });
};

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
 */
export const registerUser = async (
  username: string,
  email: string,
  password: string,
  client: SupabaseClient = supabase
) => {
  ensureCredentials(email, password);
  if (!username) {
    throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  }
  const siteUrl = resolveSiteUrl();
  const options: { data: { username: string }; emailRedirectTo?: string } = {
    data: { username },
  };
  if (siteUrl) {
    options.emailRedirectTo = `${siteUrl}/auth/callback`;
  }
  return client.auth.signUp({
    email,
    password,
    options,
  });
};

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
 */
export const logoutUser = async (client: SupabaseClient = supabase) => {
  return client.auth.signOut();
};

/**
 * æœ‰åŠ¹ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ï¼ˆæœŸé™åˆ‡ã‚Œã®å ´åˆã¯ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’è©¦ã¿ã‚‹ï¼‰
 */
export const ensureFreshSession = async (client: SupabaseClient = supabase): Promise<Session> => {
  const { data, error } = await client.auth.getSession();
  
  if (error) {
    const err: ErrorWithCode = new Error(error.message || 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    err.code = error.name;
    throw err;
  }
  
  let session = data.session;
  if (!session) {
    const err: ErrorWithCode = new Error('ã“ã®æ“ä½œã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
    err.status = 401;
    throw err;
  }
  
  const expiresAtMs = session.expires_at ? session.expires_at * 1000 : null;
  const isExpired = expiresAtMs ? expiresAtMs <= Date.now() : false;
  
  if (isExpired) {
    if (typeof client.auth.refreshSession === 'function') {
      const { data: refreshed, error: refreshError } = await client.auth.refreshSession();
      if (refreshError || !refreshed?.session) {
        const err: ErrorWithCode = new Error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸ');
        err.code = 'TOKEN_EXPIRED';
        throw err;
      }
      session = refreshed.session;
    } else {
      const err: ErrorWithCode = new Error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸ');
      err.code = 'TOKEN_EXPIRED';
      throw err;
    }
  }
  
  return session;
};

/**
 * ç”»åƒå±¥æ­´ã‚’ä¿å­˜
 */
export const persistImageHistory = async (
  image: ImageData,
  client: SupabaseClient = supabase
): Promise<ImageData> => {
  try {
    const session = await ensureFreshSession(client);
    const payload: Record<string, any> = {
      id: image.id,
      user_id: session.user.id,
      prompt: image.prompt,
      thumbnail_url: image.thumbnailUrl ?? image.imageUrl ?? null,
      created_at: image.createdAt,
      revision: image.revision ?? 0,
      title: image.title ?? '',
      saved: image.saved ?? false,
    };
    
    // ãƒ•ãƒ«ã‚µã‚¤ã‚ºç”»åƒã‚‚ä¿å­˜ï¼ˆfull_image_urlã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
    if (image.fullImageUrl || image.imageUrl) {
      payload.full_image_url = image.fullImageUrl ?? image.imageUrl ?? null;
    }
    
    console.log('ğŸ” ç”»åƒå±¥æ­´ä¿å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:', {
      id: payload.id,
      user_id: payload.user_id,
      prompt_length: payload.prompt?.length || 0,
      has_thumbnail: !!payload.thumbnail_url,
      has_full_image: !!payload.full_image_url,
      revision: payload.revision,
      title: payload.title,
      saved: payload.saved
    });
    
    const { data, error } = await client
      .from('image_histories')
      .upsert(payload, { onConflict: 'id' });
    
    // full_image_urlã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€ãã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é™¤å¤–ã—ã¦å†è©¦è¡Œ
    if (error && error.message && error.message.includes('full_image_url')) {
      console.warn('âš ï¸ full_image_urlã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ãã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é™¤å¤–ã—ã¦å†è©¦è¡Œã—ã¾ã™');
      delete payload.full_image_url;
      const { error: retryError } = await client
        .from('image_histories')
        .upsert(payload, { onConflict: 'id' });
      if (retryError) {
        logError(retryError, { action: 'persistImageHistory', imageId: image.id });
        throw retryError;
      }
      console.warn('full_image_urlã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
    } else if (error) {
      logError(error, { action: 'persistImageHistory', imageId: image.id });
      throw error;
    }
    
    console.log('âœ… ç”»åƒå±¥æ­´ä¿å­˜æˆåŠŸ:', data);
    return payload as ImageData;
  } catch (error) {
    logError(error, { action: 'persistImageHistory', imageId: image.id });
    throw error;
  }
};

/**
 * ç”»åƒå±¥æ­´ã‚’å‰Šé™¤
 */
export const removeImageHistory = async (
  imageId: string,
  client: SupabaseClient = supabase
): Promise<void> => {
  try {
    const session = await requireSession(client);
    const { error } = await client
      .from('image_histories')
      .delete()
      .eq('id', imageId)
      .eq('user_id', session.user.id);
    if (error) {
      throw error;
    }
  } catch (error) {
    logError(error, { action: 'removeImageHistory', imageId });
    throw error;
  }
};

/**
 * ç”»åƒã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ä¿å­˜
 */
export const persistImageArchive = async (
  image: ImageData,
  client: SupabaseClient = supabase
): Promise<ImageData | null> => {
  try {
    const session = await ensureFreshSession(client);
    
    // base64ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    let base64Data: string | null = null;
    if (image.fullImageUrl) {
      const parts = image.fullImageUrl.split(',');
      base64Data = parts.length > 1 ? parts[1] : image.fullImageUrl;
    } else if (image.imageUrl) {
      const parts = image.imageUrl.split(',');
      base64Data = parts.length > 1 ? parts[1] : image.imageUrl;
    }
    
    const payload = {
      id: image.id,
      user_id: session.user.id,
      prompt: image.prompt || '',
      image_base64: base64Data,
      created_at: image.createdAt || new Date().toISOString(),
      title: image.title || '',
    };
    
    console.log('ğŸ” ç”»åƒã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¿å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:', {
      id: payload.id,
      user_id: payload.user_id,
      prompt_length: payload.prompt?.length || 0,
      has_base64: !!payload.image_base64,
      base64_length: payload.image_base64 ? payload.image_base64.length : 0,
      created_at: payload.created_at
    });
    
    const { data, error } = await client
      .from('image_history_archive')
      .upsert(payload, { onConflict: 'id' });
    
    if (error) {
      logError(error, { action: 'persistImageArchive', imageId: image.id });
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚è­¦å‘Šã®ã¿ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆãªã©ï¼‰
      console.warn('ç”»åƒã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€å‡¦ç†ã¯ç¶šè¡Œã—ã¾ã™:', error.message);
      return null;
    }
    
    console.log('âœ… ç”»åƒã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¿å­˜æˆåŠŸ:', data);
    return payload as ImageData;
  } catch (error) {
    logError(error, { action: 'persistImageArchive', imageId: image.id });
    return null;
  }
};

/**
 * ç”»åƒã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’å–å¾—
 */
export const getImageArchive = async (
  client: SupabaseClient = supabase,
  limit: number = 100,
  offset: number = 0
) => {
  try {
    const session = await requireSession(client);
    const { data, error } = await client
      .from('image_history_archive')
      .select('*')
      .eq('user_id', session.user.id)
      .order('created_at', { ascending: false })
      .range(offset, offset + limit - 1);
    
    if (error) {
      logError(error, { action: 'getImageArchive', limit, offset });
      throw error;
    }
    
    return data || [];
  } catch (error) {
    logError(error, { action: 'getImageArchive', limit, offset });
    throw error;
  }
};
```

## ãƒ†ã‚¹ãƒˆè¦ä»¶
- TypeScriptã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª
- æ—¢å­˜ã®æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- å‹ãƒã‚§ãƒƒã‚¯ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒçµ±ä¸€ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

## å½±éŸ¿ç¯„å›²
- `src/lib/authService.js` â†’ `src/lib/authService.ts`
- `src/contexts/AuthContext.tsx`ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã®æ›´æ–°ï¼‰
- `src/ImageGenerator.jsx`ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã®æ›´æ–°ï¼‰
- `src/components/ImageHistoryTable.jsx`ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã®æ›´æ–°ï¼‰
- ãã®ä»–ã€`authService.js`ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«

## å®Œäº†æ¡ä»¶
- [ ] `src/lib/authService.ts`ãŒä½œæˆã•ã‚Œã€å‹å®šç¾©ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒçµ±ä¸€åŒ–ã•ã‚Œã¦ã„ã‚‹
- [ ] ã™ã¹ã¦ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹
- [ ] TypeScriptã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒãªã„
- [ ] æ—¢å­˜ã®æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] å‹ãƒã‚§ãƒƒã‚¯ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã“ã¨ã‚’ç¢ºèª

## æ³¨æ„äº‹é …
- æ—¢å­˜ã®æ©Ÿèƒ½ã‚’å£Šã•ãªã„ã‚ˆã†ã€æ…é‡ã«å¤‰æ›ã‚’è¡Œã†
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€åŒ–ã«ã‚ˆã‚Šã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é©åˆ‡ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
- ãƒ“ãƒ«ãƒ‰ãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã‚³ãƒŸãƒƒãƒˆã™ã‚‹
- ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã®æ›´æ–°æ¼ã‚ŒãŒãªã„ã‚ˆã†ã€ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã™ã‚‹

